<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Historial Sonrisas</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
    margin:0;
    font-family:'Segoe UI',sans-serif;
    background: linear-gradient(135deg,#eef2ff,#f8fafc);
}

header{
    padding:25px;
    text-align:center;
    font-size:30px;
    font-weight:bold;
}

.container{
    padding:20px;
}

.cards{
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
    gap:20px;
    margin-bottom:25px;
}

.card{
    background:rgba(255,255,255,0.7);
    backdrop-filter: blur(12px);
    border-radius:20px;
    padding:25px;
    box-shadow:0 10px 25px rgba(0,0,0,0.08);
    text-align:center;
}

.card h3{
    margin:0;
    font-size:14px;
    color:#555;
}

.card p{
    font-size:26px;
    margin-top:10px;
    font-weight:bold;
}

.filters{
    margin-bottom:25px;
}

input{
    padding:10px;
    border-radius:10px;
    border:1px solid #ccc;
    margin-right:15px;
    min-width:250px;
}

table{
    width:100%;
    border-collapse:collapse;
    background:white;
    border-radius:15px;
    overflow:hidden;
    margin-top:20px;
}

th,td{
    padding:12px;
    border-bottom:1px solid #eee;
}

th{
    background:#111827;
    color:white;
}

.section-title{
    margin-top:40px;
    margin-bottom:10px;
    font-weight:bold;
    font-size:20px;
}
</style>
</head>

<body>

<header>üòä Historial Sonrisas</header>

<div class="container">

<div class="cards">
<div class="card">
<h3>Participantes Activos</h3>
<p id="participantes">0</p>
</div>

<div class="card">
<h3>Da Sonrisas</h3>
<p id="emisores">0</p>
</div>

<div class="card">
<h3>Recibe Sonrisas</h3>
<p id="receptores">0</p>
</div>

<div class="card">
<canvas id="valorChart"></canvas>
</div>
</div>

<div class="filters">
<input type="text" id="filterDa" placeholder="Escribe quien Da Sonrisas...">
<input type="text" id="filterRecibe" placeholder="Escribe quien Recibe Sonrisas...">
</div>

<table>
<thead>
<tr>
<th>Fecha</th>
<th>Da Sonrisas</th>
<th>Recibe Sonrisas</th>
<th>Valor organizacional</th>
</tr>
</thead>
<tbody id="tablaBody"></tbody>
</table>

<div class="section-title">üîù Top 10</div>
<table>
<thead>
<tr>
<th>Trabajador</th>
<th>Total Sonrisas</th>
</tr>
</thead>
<tbody id="topBody"></tbody>
</table>

</div>

<script>

let dataGlobal = [];
let chart;

// üî• Cargar autom√°ticamente data.json
fetch("data.json")
.then(response => response.json())
.then(data => {
    dataGlobal = data;
    applyFilters();
    renderTop10(dataGlobal);
});

// Filtros tipo escritura
document.getElementById("filterDa").addEventListener("input", applyFilters);
document.getElementById("filterRecibe").addEventListener("input", applyFilters);

function applyFilters(){

    const da = document.getElementById("filterDa").value.toLowerCase();
    const recibe = document.getElementById("filterRecibe").value.toLowerCase();

    let filtered = dataGlobal.filter(r=>{

        let matchDa = true;
        let matchRecibe = true;

        if(da.length >=2){
            matchDa = r.da.toLowerCase().includes(da);
        }

        if(recibe.length >=2){
            matchRecibe = r.recibe.toLowerCase().includes(recibe);
        }

        return matchDa && matchRecibe;
    });

    renderTable(filtered);
    updateCards(filtered);
    renderChart(filtered);
}

function renderTable(data){
    const tbody = document.getElementById("tablaBody");
    tbody.innerHTML="";
    data.forEach(r=>{
        tbody.innerHTML+=`
        <tr>
        <td>${r.fecha}</td>
        <td>${r.da}</td>
        <td>${r.recibe}</td>
        <td>${r.valor}</td>
        </tr>`;
    });
}

function updateCards(data){

    const participantes = new Set();
    const emisores = new Set();
    const receptores = new Set();

    data.forEach(r=>{
        participantes.add(r.da);
        participantes.add(r.recibe);
        emisores.add(r.da);
        receptores.add(r.recibe);
    });

    document.getElementById("participantes").innerText = participantes.size;
    document.getElementById("emisores").innerText = emisores.size;
    document.getElementById("receptores").innerText = receptores.size;
}

function renderChart(data){

    const valores={};
    data.forEach(r=>{
        valores[r.valor]=(valores[r.valor]||0)+1;
    });

    const labels = Object.keys(valores);
    const total = Object.values(valores).reduce((a,b)=>a+b,0) || 1;
    const percentages = Object.values(valores).map(v=>((v/total)*100).toFixed(1));

    if(chart) chart.destroy();

    chart = new Chart(document.getElementById("valorChart"),{
        type:"doughnut",
        data:{
            labels:labels,
            datasets:[{data:percentages}]
        },
        options:{
            responsive:true,
            plugins:{
                tooltip:{
                    callbacks:{
                        label:function(ctx){
                            return ctx.label+": "+ctx.parsed+"%";
                        }
                    }
                }
            }
        }
    });
}

function renderTop10(data){

    const counts={};

    data.forEach(r=>{
        counts[r.recibe]=(counts[r.recibe]||0)+1;
    });

    const sorted = Object.entries(counts)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,10);

    const tbody = document.getElementById("topBody");
    tbody.innerHTML="";

    sorted.forEach(r=>{
        tbody.innerHTML+=`
        <tr>
        <td>${r[0]}</td>
        <td>${r[1]}</td>
        </tr>`;
    });
}

</script>

</body>
</html>
