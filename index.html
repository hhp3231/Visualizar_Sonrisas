<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Historial Sonrisas</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
    margin:0;
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg,#eef2ff,#f8fafc);
}

header{
    padding:20px;
    text-align:center;
    font-size:28px;
    font-weight:bold;
}

.container{
    padding:20px;
}

.cards{
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(200px,1fr));
    gap:20px;
    margin-bottom:20px;
}

.card{
    background:rgba(255,255,255,0.7);
    backdrop-filter: blur(10px);
    border-radius:18px;
    padding:20px;
    box-shadow:0 10px 25px rgba(0,0,0,0.08);
    text-align:center;
}

.card h3{
    margin:0;
    font-size:14px;
    color:#555;
}

.card p{
    font-size:24px;
    margin-top:10px;
    font-weight:bold;
}

.filters{
    margin-bottom:20px;
}

input, select{
    padding:8px;
    border-radius:8px;
    border:1px solid #ccc;
    margin-right:10px;
}

button{
    padding:8px 15px;
    border-radius:8px;
    border:none;
    background:#6366f1;
    color:white;
    cursor:pointer;
}

table{
    width:100%;
    border-collapse:collapse;
    background:white;
    border-radius:15px;
    overflow:hidden;
}

th,td{
    padding:10px;
    border-bottom:1px solid #eee;
}

th{
    background:#111827;
    color:white;
}

.section-title{
    margin-top:40px;
    margin-bottom:10px;
    font-weight:bold;
    font-size:18px;
}
</style>
</head>

<body>

<header>üòä Historial Sonrisas</header>

<div class="container">

<input type="file" id="fileInput">

<div class="cards">
<div class="card">
<h3>Participantes Activos</h3>
<p id="participantes">0</p>
</div>

<div class="card">
<h3>Da Sonrisas</h3>
<p id="emisores">0</p>
</div>

<div class="card">
<h3>Recibe Sonrisas</h3>
<p id="receptores">0</p>
</div>

<div class="card">
<canvas id="valorChart"></canvas>
</div>
</div>

<div class="filters">
<input type="date" id="startDate">
<input type="date" id="endDate">

<select id="filterDa"></select>
<select id="filterRecibe"></select>

<select id="groupByMonth">
<option value="no">Sin agrupar</option>
<option value="month">Agrupar por mes</option>
</select>

<button onclick="applyFilters()">Aplicar filtros</button>
</div>

<table>
<thead>
<tr>
<th>Fecha</th>
<th>Da Sonrisas</th>
<th>Recibe Sonrisas</th>
<th>Valor organizacional</th>
</tr>
</thead>
<tbody id="tablaBody"></tbody>
</table>

<div class="section-title">üîù Top 10 (Solo cambia por fecha)</div>
<table>
<thead>
<tr>
<th>Trabajador</th>
<th>Total Sonrisas</th>
</tr>
</thead>
<tbody id="topBody"></tbody>
</table>

</div>

<script>

let dataGlobal = [];
let chart;

// Cargar CSV
document.getElementById("fileInput").addEventListener("change",function(e){
    const file = e.target.files[0];
    const reader = new FileReader();

    reader.onload = function(event){
        const rows = event.target.result.split("\n").map(r=>r.split(","));
        rows.shift();
        dataGlobal = rows.filter(r=>r.length>=4);
        fillSelects();
        applyFilters();
    };

    reader.readAsText(file);
});

function fillSelects(){
    const daSet = new Set();
    const recibeSet = new Set();

    dataGlobal.forEach(r=>{
        daSet.add(r[1]);
        recibeSet.add(r[2]);
    });

    const daSelect = document.getElementById("filterDa");
    const recibeSelect = document.getElementById("filterRecibe");

    daSelect.innerHTML='<option value="">Todos (Da)</option>';
    recibeSelect.innerHTML='<option value="">Todos (Recibe)</option>';

    daSet.forEach(v=>{
        daSelect.innerHTML+=`<option>${v}</option>`;
    });

    recibeSet.forEach(v=>{
        recibeSelect.innerHTML+=`<option>${v}</option>`;
    });
}

function applyFilters(){

    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;
    const da = document.getElementById("filterDa").value;
    const recibe = document.getElementById("filterRecibe").value;
    const groupMonth = document.getElementById("groupByMonth").value;

    let filtered = dataGlobal.filter(r=>{
        let fecha = r[0];
        return (!start || fecha>=start) &&
               (!end || fecha<=end) &&
               (!da || r[1]==da) &&
               (!recibe || r[2]==recibe);
    });

    renderTable(filtered);
    updateCards(filtered);
    renderChart(filtered);

    // Top 10 solo por fecha
    let dateFiltered = dataGlobal.filter(r=>{
        let fecha = r[0];
        return (!start || fecha>=start) &&
               (!end || fecha<=end);
    });

    renderTop10(dateFiltered, groupMonth);
}

function renderTable(data){
    const tbody = document.getElementById("tablaBody");
    tbody.innerHTML="";
    data.forEach(r=>{
        tbody.innerHTML+=`
        <tr>
        <td>${r[0]}</td>
        <td>${r[1]}</td>
        <td>${r[2]}</td>
        <td>${r[3]}</td>
        </tr>`;
    });
}

function updateCards(data){

    const participantes = new Set();
    const emisores = new Set();
    const receptores = new Set();

    data.forEach(r=>{
        participantes.add(r[1]);
        participantes.add(r[2]);
        emisores.add(r[1]);
        receptores.add(r[2]);
    });

    document.getElementById("participantes").innerText = participantes.size;
    document.getElementById("emisores").innerText = emisores.size;
    document.getElementById("receptores").innerText = receptores.size;
}

function renderChart(data){

    const valores={};
    data.forEach(r=>{
        valores[r[3]]=(valores[r[3]]||0)+1;
    });

    const labels = Object.keys(valores);
    const total = Object.values(valores).reduce((a,b)=>a+b,0);
    const percentages = Object.values(valores).map(v=>((v/total)*100).toFixed(1));

    if(chart) chart.destroy();

    chart = new Chart(document.getElementById("valorChart"),{
        type:"doughnut",
        data:{
            labels:labels,
            datasets:[{data:percentages}]
        },
        options:{
            plugins:{
                tooltip:{
                    callbacks:{
                        label:function(ctx){
                            return ctx.label+": "+ctx.parsed+"%";
                        }
                    }
                }
            }
        }
    });
}

function renderTop10(data, groupMonth){

    const counts={};

    data.forEach(r=>{
        let key = r[2]; // trabajador que recibe
        if(groupMonth==="month"){
            key = r[2]+" ("+r[0].substring(0,7)+")";
        }
        counts[key]=(counts[key]||0)+1;
    });

    const sorted = Object.entries(counts)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,10);

    const tbody = document.getElementById("topBody");
    tbody.innerHTML="";

    sorted.forEach(r=>{
        tbody.innerHTML+=`
        <tr>
        <td>${r[0]}</td>
        <td>${r[1]}</td>
        </tr>`;
    });
}

</script>
</body>
</html>
